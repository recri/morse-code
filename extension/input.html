<!DOCTYPE html>
<html class="no-js" lang="">
  <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>Morse Code Input</title>
        <meta name="description" content="morse code input">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
  </head>
  <body onload="onLoadHandler()">
    <!--[if lt IE 8]>
        <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div class="page">
      <h1>Morse Code Input</h1>
      <div class="center">
	<h2>Key Focus</h2>
	<!-- alternate straight2.jpg -->
	<input id="key_focus" type="image" src="paddle1.jpg" width="160px" height="120px" alt="iambic paddle"
	       onfocus="station.input.onfocus()" onblur="station.input.onblur()"
	       onkeydown="station.input.onkeydown(event)" onkeyup="station.input.onkeyup(event)"
	       onmousedown="station.input.onmousedown(event)" onmouseup="station.input.onmouseup(event)"
	       oncontextmenu="return false"
	       </input>
      </div>
      <div class="center">
	<h2>Input Text</h2>
	<div id="input_text" class="center"></div>
	<button onclick="document.getElementById('input_text').innerHTML = ''">Clear Input</button>
      </div>
      <div class="center">
	<h2>Key Type</h2>
	<form id="key_type" onchange="key_type_select()">
	  <input type="radio" name="key_type" value="straight" align="left">Straight Key<br/>
	  <input type="radio" name="key_type" value="iambic" align="left" checked>Iambic Key<br/>
	</form>
	<h2>MIDI Device</h2>
	<form id="key_input" onchange="key_input_select()">
	  <!-- <input type="radio" name="key_input" value="keyboard" align="left" checked>Keyboard<br/> -->
	  <!-- <input type='radio' name='key_input' value='mouse' align="left">Mouse<br/> -->
	  <!-- <input type="radio" name="key_input" value="touch" align="left">Touch<br/> -->
	  <!-- append MIDI devices here
	       <input type="radio" name="key_input" value="midi">MIDI<br/>
	       -->
	</form>
	<form id="recheck_midi">
	  <button type="button" onclick="key_input_regenerate_list()">Recheck MIDI</button>
	</form>
	  
	<h2>Input</h2>
	<div id="input_pitch"></div>
	<div id="input_gain"></div>
	<div id="input_speed"></div>
	<div id="input_rise_time"></div>
	<div id="input_fall_time"></div>
	<form id="input_swap" onchange="input_swap_paddles()">
	  <input type="checkbox" name="input_swap" value="1">Swap Paddles</input>
	</form>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')</script>
    <script src="js/plugins.js"></script>
    <script src="js/main.js"></script>
    <script src="js/morse.js"></script>
    <script>
      var station = morse_code_station();
      station.input_decoder.on('letter', function(ltr, code) {
        var elt = document.getElementById("input_text");
        elt.textContent += ltr;
        elt.scrollTop = 1000;
      });
      function find_item_checked(name) {
        var radios = document.getElementsByName(name);
        for (var i in radios)
          if (radios[i].checked)
	    return radios[i].value;
        return null;
      }
      function set_item_checked(name, value) {
        var radios = document.getElementsByName(name);
        for (var i in radios)
          radios[i].checked = (radios[i].value == value);
      }
      function key_type_select() {
        var name = 'key_type';
        var key_type = find_item_checked(name);
        if (key_type != station.key_type) {
          // adapt front end: image and handlers
          var i = document.getElementById('key_focus')
          if (key_type == 'straight') {
            i.src = "straight2.jpg";
            i.alt = "straight telegraph key";
          } else {
            i.src = "paddle1.jpg";
            i.alt = "iambic paddle key";
          }
          // let the back end adapt
          station.key_type_select(key_type);
        }
      }
      function key_input_select() {
	station.key_input_select(find_item_checked('key_input'));
      }
      function key_input_regenerate_list() {
        // try to preserve the selected value if possible
        var key_input = document.getElementById('key_input');
        var checked = find_item_checked('key_input');
	if (key_input) {
          key_input.innerHTML = "";
	  // key_input.innerHTML += "<input type='radio' name='key_input' value='keyboard' align='left'>Keyboard<br/>";
          // key_input.innerHTML += "<input type='radio' name='key_input' value='mouse align='left'>Mouse<br/>"
          // key_input.innerHTML += "<input type='radio' name='key_input' value='touch' align='left'>Touch<br/>"
          var names = station.midi_key.names();
          for (var i in names) {
	    // console.log("adding "+names[i]+" to midi inputs");
            key_input.innerHTML += "<input type='radio' name='key_input' value='"+names[i]+"' align='left'>"+names[i]+"<br/>";
          }
	  if (checked) set_item_checked('key_input', checked);
	}
      }
      function input_swap_paddles() {
        var value = find_item_checked('input_swap') == 1;
        // console.log("input_swap_paddles "+value);
        station.input.setSwapped(value);
      }
      function slider(id, min, max, value, units, target, ident) {
        // console.log("slider("+id+")");
        var inputid = id+"_input";
        var valueid = id+"_value";
        var identid = id+"_identity";
	document.getElementById(id).innerHTML = '<span id="'+identid+'"></span><input id="'+inputid+'"></input><br/><span id="'+valueid+'"></span>';
        var inp = document.getElementById(inputid);
	var val = document.getElementById(valueid);
        var tag = document.getElementById(identid);
        inp.type = "range";
	inp.min = min;
	inp.max = max;
        if (ident) tag.innerText = ident;
        var target_value = inp.value;
	if (units == "dB") {
          inp.oninput = inp.onchange = function() {
            val.innerHTML = ""+inp.value+" "+units;
	    target(Math.pow(10, inp.value/20))
          }
        } else if (units == "ms") {
          inp.oninput = inp.onchange = function() {
            val.innerHTML = ""+inp.value+" "+units;
	    target(inp.value/1000)
          }
        } else {
          inp.oninput = inp.onchange = function() {
            val.innerHTML = ""+inp.value+" "+units;
	    target(inp.value)
          }
        }
	inp.value = value;
        inp.onchange();
      };
      function onLoadHandler() {
	slider("input_pitch", "220", "1760", "550", "Hz", station.input.setPitch, "  Pitch  ");
	slider("input_gain", "-60", "0", "-24", "dB", station.input.setGain, "  Gain  ");
	slider("input_speed", "5", "30", "15", "WPM", station.input.setWPM, "  Speed  ");
        slider("input_rise_time", "1", "10", "4", "ms", station.input.setOnTime, "  Rise  ");
        slider("input_fall_time", "1", "10", "4", "ms", station.input.setOffTime, "  Fall  ");
        key_input_regenerate_list();
        key_type_select();
      };
    </script>
  </body>
</html>


